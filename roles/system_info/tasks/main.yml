---
# System Info Role - Collect and display system information

- name: Gather system facts
  ansible.builtin.setup:
    gather_subset:
      - all

- name: Collect system information
  ansible.builtin.set_fact:
    system_info:
      hostname: "{{ inventory_hostname }}"
      ip_address: "{{ ansible_host }}"
      os_family: "{{ ansible_os_family }}"
      os_distribution: "{{ ansible_distribution }}"
      os_version: "{{ ansible_distribution_version }}"
      os_full: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
      kernel_version: "{{ ansible_kernel }}"
      architecture: "{{ ansible_architecture }}"
      processor_cores: "{{ ansible_processor_vcpus }}"
      memory_total_mb: "{{ ansible_memtotal_mb }}"
      python_version: "{{ ansible_python_version }}"
      fqdn: "{{ ansible_fqdn }}"
      default_ipv4: "{{ ansible_default_ipv4.address | default('N/A') }}"
      uptime_seconds: "{{ ansible_uptime_seconds | default('N/A') }}"

- name: Display system information
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "System Information for {{ system_info.hostname }}"
      - "=========================================="
      - "IP Address:        {{ system_info.ip_address }}"
      - "Default IPv4:      {{ system_info.default_ipv4 }}"
      - "FQDN:              {{ system_info.fqdn }}"
      - "OS:                {{ system_info.os_full }}"
      - "OS Family:         {{ system_info.os_family }}"
      - "Kernel:            {{ system_info.kernel_version }}"
      - "Architecture:      {{ system_info.architecture }}"
      - "CPU Cores:         {{ system_info.processor_cores }}"
      - "Total Memory:      {{ system_info.memory_total_mb }} MB"
      - "Python Version:    {{ system_info.python_version }}"
      - "Uptime (seconds):  {{ system_info.uptime_seconds }}"
      - "=========================================="
  when: system_info_display | bool

- name: Ensure reports directory exists on controller
  ansible.builtin.file:
    path: "{{ system_info_report_path }}"
    state: directory
    mode: '0755'
  delegate_to: controller
  run_once: true
  when: system_info_generate_report | bool

- name: Generate system report on controller
  ansible.builtin.template:
    src: system_report.j2
    dest: "{{ system_info_report_path }}/{{ inventory_hostname }}_system_report.txt"
    mode: '0644'
  delegate_to: controller
  when: system_info_generate_report | bool

- name: Find all generated report files on controller
  ansible.builtin.find:
    paths: "{{ system_info_report_path }}"
    patterns: "*_system_report.txt"
  delegate_to: controller
  run_once: true
  register: report_files
  when: system_info_generate_report | bool

- name: Read all report files on controller
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  delegate_to: controller
  run_once: true
  loop: "{{ report_files.files }}"
  register: report_contents
  when: system_info_generate_report | bool and report_files.matched > 0

- name: Generate consolidated HTML report on controller
  ansible.builtin.template:
    src: consolidated_html.j2
    dest: "{{ system_info_report_path }}/infrastructure_report.html"
    mode: '0644'
  delegate_to: controller
  run_once: true
  vars:
    reports: "{{ report_contents.results }}"
  when: system_info_generate_report | bool and report_files.matched > 0
